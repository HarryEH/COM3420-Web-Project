- content_for :title, 'Map'

- content_for :scripts do
  = javascript_include_tag 'map'
  %script{:src => '//maps.google.com/maps/api/js', :type => 'text/javascript'}
  = yield :scripts
.row
  .col-md-12
    .page-header
      %h1
        Interactive Map
      %h3
        %small
          Click on a marker to see a memory
      %h3
        %small
          Filter the map using the settings below
      %input{:onclick => 'selectBox()', :type => 'checkbox', :id => 'rec_cb', :checked => true}
      %label{:for => "rec_cb"} Recordings
      %input{:onclick => 'selectBox()', :type => 'checkbox', :id => 'doc_cb', :checked => true}
      %label{:for => "doc_cb"} Document
      %input{:onclick => 'selectBox()', :type => 'checkbox', :id => 'img_cb', :checked => true}
      %label{:for => "img_cb"} Images
      %input{:onclick => 'selectBox()', :type => 'checkbox', :id => 'txt_cb', :checked => true}
      %label{:for => "text_cb"} Text

      %br
      %label{:for => 'date_t'} Date:
      %input.datepicker{:onclick=>'dateFilter()',label: 'Date', placeholder: 'dd-mm-yyyy', as: :string, :id => 'date_t'}
      %input{:onclick => 'dateFilter()', :type => 'checkbox', :id => 'before', :checked => false}
      %label{:for => 'before'} Before
      %input{:onclick => 'dateFilter()', :type => 'checkbox', :id => 'after', :checked => false}
      %label{:for => 'after'} After

  // Map
  .col-md-12
    %div.panel.panel-default
      %div.panel-body

        #map{:style => 'width: 100%; height: 510px; padding: 10px;'}

        -marker_json = @lat_lng.to_json


:javascript


    var map;

    //This filters the map by date
    function dateFilter() {
      var returnMarkers = []
      if (document.getElementById("date_t").value != "") {
        if (document.getElementById("before").checked && !document.getElementById("after").checked){
          for (i = 0; i < markers.length; i++) {
            if (markers[i].date != "" && new Date(markers[i].date) < new Date(document.getElementById("date_t").value)){
              returnMarkers.push(markers[i]);
              console.log("bants");
            }
           }
        } else if (document.getElementById("after").checked && !document.getElementById("before").checked){
          for (i = 0; i < markers.length; i++) {
              if (markers[i].date != "" && new Date(markers[i].date) > new Date(document.getElementById("date_t").value)){
                returnMarkers.push(markers[i]);
                console.log("shit");
              }
           }
        } else if (!document.getElementById("before").checked && !document.getElementById("after").checked) {
          for (i = 0; i < markers.length; i++) {
              if (markers[i].date != "" && new Date(markers[i].date) == new Date(document.getElementById("date_t").value)){
                returnMarkers.push(markers[i]);
                console.log("willy");
              }
           }
        } else {
          returnMarkers = markers
        }
        map.removeMarkers();
        map.addMarkers(returnMarkers);
      }
    }

    $(function() {
      $('input.datepicker').data({behaviour: "datepicker"}).datepicker({
        format: "yyyy-mm-dd",
        onSelect: function(date) {
          dateFilter();
        },
        onClose: function(date) {
          dateFilter();
        },
        onClick: function(date) {
        $('before').prop('checked', false);
        $('after').prop('checked', false);
        },
        onChange: function(date) {
          dateFilter();
        }
      });

    });

    //This filters by type
    function selectBox() {
      var returnMarkers = [];
      if (document.getElementById("rec_cb").checked) {
        for (i = 0; i < markers.length; i++) {
          if (markers[i].type == "Recording"){
            returnMarkers.push(markers[i]);
          }
        }
      }
      if (document.getElementById("doc_cb").checked) {
        for (i = 0; i < markers.length; i++) {
          if (markers[i].type == "Document"){
           returnMarkers.push(markers[i]);
          }
        }
      }
      if (document.getElementById("img_cb").checked) {
        for (i = 0; i < markers.length; i++) {
          if (markers[i].type == "Image"){
            returnMarkers.push(markers[i]);
          }
        }
      }
      if (document.getElementById("txt_cb").checked) {
        for (i = 0; i < markers.length; i++) {
          if (markers[i].type == "Text"){
            returnMarkers.push(markers[i]);
          }
        }
      }
      map.removeMarkers();
      map.addMarkers(returnMarkers);
    }

    //This js is required, every other map was dreadful.
    $(document).ready( function() {
      map = new GMaps({
          el: '#map',
          lat: 53.452,
          lng: -1.212,
          zoom: 13,
      });
      //This adds listeners to each marker
      var x = map.addMarkers(#{marker_json});
    });

    var markers= #{marker_json};






