- content_for :title, 'Map'

- content_for :scripts do
  = javascript_include_tag 'map'
  %script{:src => "//maps.google.com/maps/api/js", :type => "text/javascript"}
  = yield :scripts
%div.panel.panel-default
  %div.panel-body

    #map{:style => 'width: 70%; height: 510px; padding: 10px;'}

    %br
    -#  the table only appears if you have clicked on an item displayed on the map
    -if @result
      %table.table.table-bordered{:style => 'width: 70%;'}
        %tr
          %th Title:
          %td#title
            %a{:href => "media/#{raw @result.medium_id}"}
              =@result.title
        %tr
          %th Date:
          %td#date
            =@result.ref_date
        %tr
          %th Location:
          %td#location
            =@result.location

    -#this div is for the javascript to submit a form to the controller
    %div.hidden
      = form_tag(map_path, method: "post") do
        = text_field_tag(:lat, params[:lat], :class => "form-control", :id => 'lat_tag')
        = text_field_tag(:lng, params[:lat], :class => "form-control", :id => 'lng_tag')
        = submit_tag('Search', :class => "btn btn-default", :id => 'Search')


:javascript
    $(document).ready( function() {
      map = new GMaps({
          el: '#map',
          lat: 53.452,
          lng: -1.212,
          zoom: 13,
      });

      console.log(#{raw @result.to_json});

      //This adds listeners to each marker
      var markers = map.addMarkers(#{raw @lat_lng.to_json});
      for (i = 0; i < markers.length; i++) {
        //This adds listeners to each marker so that they perform
        //an action on clicking them.
        markers[i].addListener('click', function(evt) {
          //TODO ADD ON CLICK HERE!!!
          console.log('pre form: '+this.position.lat()+', '+ this.position.lng());
          //this sets the form's latitude
          var lat = this.position.lat();
          var lat_input = document.getElementById('lat_tag');
          lat_input.empty();
          lat_input.value = lat_input.value + lat;

          //this sets the form's longitude
          var lng = this.position.lng();
          var lng_input = document.getElementById('lng_tag');
          lng_input.empty();
          lng_input.value = lng_input.value + lng;

          //debugging log
          console.log('form values: '+document.getElementById('lat_tag').value+', '+document.getElementById('lng_tag').value)

          //this triggers the form
          document.getElementById('Search').click();

        });
      }
    });


